name: Release Binaries

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build/upload (e.g. v0.2.0)"
        required: true

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          check-latest: true

      - name: Install system dependencies (audio + cross-compile)
        run: |
          sudo apt-get update
          # Native amd64: audio libs for linux/amd64 build
          sudo apt-get install -y libasound2-dev
          # ARM64 cross-compiler and ARM64 ALSA libs for linux/arm64 build
          sudo apt-get install -y gcc-aarch64-linux-gnu
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y libasound2-dev:arm64

      - name: Build linux binaries (amd64 + arm64)
        shell: bash
        run: |
          set -euo pipefail
          ref="${{ inputs.tag }}"
          if [ -z "$ref" ]; then ref="${GITHUB_REF_NAME}"; fi
          version="${ref#v}"
          mkdir -p dist/build dist/out/pkg

          # Build linux amd64 with CGO enabled (links to system audio libs)
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o dist/build/sag-linux-amd64 ./cmd/sag

          # Build linux arm64 with CGO (use cross-compiler so runtime/cgo assembler is correct)
          CGO_ENABLED=1 CC=aarch64-linux-gnu-gcc GOOS=linux GOARCH=arm64 go build -o dist/build/sag-linux-arm64 ./cmd/sag

          cp README.md LICENSE dist/out/pkg/

          # Package amd64
          cp dist/build/sag-linux-amd64 dist/out/pkg/sag
          tar -C dist/out/pkg -czf "dist/out/sag_${version}_linux_amd64.tar.gz" sag README.md LICENSE
          sha256sum "dist/out/sag_${version}_linux_amd64.tar.gz" > "dist/out/sag_${version}_linux_amd64.tar.gz.sha256"

          # Package arm64
          cp dist/build/sag-linux-arm64 dist/out/pkg/sag
          tar -C dist/out/pkg -czf "dist/out/sag_${version}_linux_arm64.tar.gz" sag README.md LICENSE
          sha256sum "dist/out/sag_${version}_linux_arm64.tar.gz" > "dist/out/sag_${version}_linux_arm64.tar.gz.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: |
            dist/out/*.tar.gz
            dist/out/*.sha256

  
  upload:
    runs-on: ubuntu-latest
    needs: [build-linux]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten dist
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          find dist -type f -maxdepth 3 -print0 | xargs -0 -I{} cp {} out/

          ref="${{ inputs.tag }}"
          if [ -z "$ref" ]; then ref="${GITHUB_REF_NAME}"; fi
          version="${ref#v}"
          cat out/*.sha256 > "out/sag_${version}_checksums.txt"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          files: out/*
